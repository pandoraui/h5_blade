define(["UIHeader","UILoadingLayer"],function(a,b){return _.inherit({propertys:function(){this.viewRootPath="demo/views/",this.defaultView="index",this.request,this.viewId,this.mainframe,this.viewport,this.views={},this.viewMapping={},this.isCreate=!1,this.status="init",this.$wrapper=$("body"),this.$mainframe=$("#main"),this.interface=["forward","back","loadSubView"],this.appmode="mobile",this.loading=new b({content:"正在拉取js...",closeBtn:!0})},initialize:function(a){this.propertys(),this.setOption(a),this.createViewPort(),this.loadViewByUrl(),this.buildEvent()},setOption:function(a){_.extend(this,a)},createViewPort:function(){if(!this.isCreate){var b="",c='<div class="header-wrapper"></div>',d='<div class="viewport-wrapper"></div>';this.$mainframe[0]||(b=['<div class="main">',"</div>"].join(""),this.$mainframe=$(b),this.$wrapper.append(this.$mainframe)),this.$mainframe.html(c+d),this.$header=this.$mainframe.find(".header-wrapper"),this.$viewport=this.$mainframe.find(".viewport-wrapper"),this.header=new a({wrapper:this.$header}),this.isCreate=!0}},buildEvent:function(){this.hasPushState?$(window).bind("popstate",_.bind(this.loadViewByUrl,this)):$(window).bind("hashchange",_.bind(this.loadViewByUrl,this))},loadViewByUrl:function(){this.parseUrl(),this.switchView(this.viewId)},parseUrl:function(){var a=decodeURIComponent(location.href).toLowerCase(),b=this.getViewIdRule(a);b=b||this.defaultView,this.viewId=b,this.request={viewId:b,path:a}},switchView:function(a){var b=a,c=this.views[b],d=this.curView;if(d&&d!=c&&(this.lastView=d),c){if(c==this.curView)return;this.curView=c,this.curView.show(),this.lastView&&this.lastView.hide()}else this.loading.show(),this.loadView(a,function(a){if(!($('[page-url="'+b+'"]').length>0)){this.curView=new a({APP:this,wrapper:this.$viewport}),this.curView.$root.attr("page-url",b),this.views[b]=this.curView;{"undefined"!=typeof d?d.viewname:null}this.curView.show(),this.lastView&&this.lastView.hide(),this.loading.hide()}})},loadView:function(a,b){var c=this;requirejs([this.buildUrl(a)],function(a){b&&b.call(c,a)})},buildUrl:function(a){"ipad"==this.appmode&&(a+=".ipad");var b=this.viewMapping[a];return b?b:this.viewRootPath+a},getViewIdRule:function(a){var b,c,d="";return this.hasPushState?d=_.getUrlParam(a,"viewid"):(d=a.replace(/^[^#]+(#(.+))?/g,"$2").toLowerCase().replace(/^#+/i,""),b=/^([^?&|]*)(.*)?$/i.exec(d),c=b[1]?b[1].split("!"):[],d=(c.shift()||"").replace(/(^\/+|\/+$)/i,"")),d},setUrlRule:function(a,b,c){if(this.hasPushState){var d,e=window.location.href,f="",g="";if(c)for(d in c)f+="&"+d+"="+c[d];g=e.indexOf("?")?e.substr(0,e.indexOf("?"))+"?viewid="+a:e+"?viewid="+a,b?history.replaceState("",{},g+f):history.pushState("",{},g+f)}else b?window.location.replace(("#"+a).replace(/^#+/,"#")):window.location.href=("#"+a).replace(/^#+/,"#")},forward:function(a,b){if(a){b=b||{};var c=b.replace,d=b.isNotAnimat;param=b.param,a=a.toLowerCase(),d&&(this.isAnimat=!1),this.animatName=b.animatName||this.animForwardName,this.setUrlRule(a,c,param),this.hasPushState&&this.loadViewByUrl()}},back:function(a,b){b=b||{};var c=b.isNotAnimat;c&&(this.isAnimat=!1),this.animatName=this.animBackwardName,a?(b.animatName=this.animBackwardName,this.forward(a,b)):1==window.history.length?this.forward(this.defaultView,b):history.back()}})});